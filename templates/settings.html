{% extends "base.html" %}
{% block title %}Settings — Fiarrd{% endblock %}
{% block content %}

<h1>Settings</h1>

{% if saved %}
<div class="alert" style="background:#065f46;border:1px solid #047857;color:#6ee7b7;margin-bottom:20px">
  ✓ Settings saved successfully.
</div>
{% endif %}

{% if error %}
<div class="alert alert-warn">{{ error }}</div>
{% endif %}

<div class="card" style="max-width:800px;margin-bottom:20px">
  <h2>Job Feeds</h2>
  <p style="font-size:13px;color:#64748b;margin-bottom:16px">
    RSS/Atom feed URLs to poll daily for new job postings. New postings are added as
    <strong style="color:#fde68a">Prospect</strong> opportunities — no AI calls at ingest time.
    Run Score Fit from the opportunity page once you decide a posting is worth pursuing.
  </p>
  <form method="POST" action="/settings">
    <input type="hidden" name="section" value="feeds">
    <div class="form-group">
      <label>RSS / Atom Feed URLs (one per line)</label>
      <textarea name="feed_urls" rows="5" placeholder="https://www.indeed.com/rss?q=analytics+manager&l=Charlotte+NC&#10;https://remoteok.com/remote-jobs.rss&#10;https://weworkremotely.com/categories/remote-data-science-jobs.rss">{{ feed_urls_text }}</textarea>
    </div>
    <div class="form-group">
      <label>Keyword Filter (comma-separated — only import titles matching at least one)</label>
      <input type="text" name="feed_keywords" value="{{ feed_keywords_text }}" placeholder="analytics manager, data manager, BI manager, decision science">
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <button type="submit" class="btn btn-primary">Save Feeds</button>
      <button type="button" class="btn btn-ghost" id="poll-btn" onclick="pollNow()">Poll Now</button>
      <span id="poll-result" style="font-size:13px;color:#64748b"></span>
    </div>
  </form>
</div>

<div class="card" style="max-width:800px;margin-bottom:20px">
  <h2>Email / SMTP</h2>
  <p style="font-size:13px;color:#64748b;margin-bottom:16px">
    LAN relay settings used when sending outreach and thank-you emails from the web UI.
    Overrides the env-var defaults without touching <code style="background:#0f172a;padding:2px 6px;border-radius:4px">.env</code>.
  </p>
  <form method="POST" action="/settings">
    <input type="hidden" name="section" value="smtp">
    <div style="display:grid;grid-template-columns:1fr 120px;gap:16px">
      <div class="form-group">
        <label>SMTP Host</label>
        <input type="text" name="smtp_host" value="{{ smtp_host }}">
      </div>
      <div class="form-group">
        <label>Port</label>
        <input type="number" name="smtp_port" value="{{ smtp_port }}">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group">
        <label>From Address</label>
        <input type="text" name="smtp_from" value="{{ smtp_from }}">
      </div>
      <div class="form-group">
        <label>Sender Name</label>
        <input type="text" name="sender_name" value="{{ sender_name }}">
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Save SMTP</button>
  </form>
</div>

<div class="card" style="max-width:800px;margin-bottom:20px">
  <h2>Scheduler</h2>
  <p style="font-size:13px;color:#64748b;margin-bottom:16px">
    Daily digest and stale-record check are run automatically at this time while the dashboard is running.
  </p>
  <form method="POST" action="/settings">
    <input type="hidden" name="resume_text" value="{{ resume_text | e }}">
    <div class="form-group" style="max-width:160px">
      <label>Digest Time (24h)</label>
      <input type="time" name="digest_time" value="{{ digest_time }}">
    </div>
    <button type="submit" class="btn btn-primary">Save Time</button>
  </form>
</div>

<div class="card" style="max-width:800px">
  <h2>Resume Cache</h2>
  <p style="font-size:13px;color:#64748b;margin-bottom:16px">
    This text is used by AI Fit Scoring to evaluate your resume against job descriptions.
    Keep it current — paste your full resume in plain text.
    <br><span style="font-size:12px;color:#475569">Saved to: <code style="background:#0f172a;padding:2px 6px;border-radius:4px">{{ resume_path }}</code></span>
  </p>
  <form method="POST" action="/settings">
    <input type="hidden" name="digest_time" value="{{ digest_time }}">
    <div class="form-group">
      <label>Resume Text</label>
      <textarea name="resume_text" rows="28" placeholder="Paste your full resume here in plain text...&#10;&#10;SUMMARY&#10;...&#10;&#10;EXPERIENCE&#10;...">{{ resume_text }}</textarea>
    </div>
    <button type="submit" class="btn btn-primary">Save Resume</button>
  </form>
</div>

<script>
function pollNow() {
  const btn = document.getElementById('poll-btn');
  const result = document.getElementById('poll-result');
  btn.disabled = true;
  btn.textContent = 'Polling...';
  result.textContent = '';
  fetch('/run-feed-poll', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.textContent = 'Poll Now';
      if (data.error) {
        result.style.color = '#ef4444';
        result.textContent = data.error;
        return;
      }
      result.style.color = data.added > 0 ? '#10b981' : '#64748b';
      result.textContent = `Done — ${data.added} added, ${data.skipped} skipped, ${data.errors} errors.`;
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = 'Poll Now';
      result.style.color = '#ef4444';
      result.textContent = 'Request failed.';
    });
}
</script>
{% endblock %}

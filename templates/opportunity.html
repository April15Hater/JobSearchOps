{% extends "base.html" %}
{% block title %}{{ opp.company }} ‚Äî {{ opp.role_title }}{% endblock %}
{% block content %}

<div style="margin-bottom:20px">
  <a href="/opportunities" style="color:#64748b;font-size:13px">‚Üê Pipeline</a>
</div>

<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px">
  <div>
    <h1 style="margin-bottom:4px">{{ opp.company }}</h1>
    <div style="color:#94a3b8;font-size:15px">{{ opp.role_title }}</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div style="background:#1e293b;border:1px solid #334155;border-radius:8px;padding:10px 16px;text-align:center{% if not opp.fit_score %};opacity:.4{% endif %}">
      <div id="fit-score-display" style="font-size:22px;font-weight:700;color:{% if opp.fit_score %}{% if opp.fit_score >= 8 %}#10b981{% elif opp.fit_score >= 6 %}#f59e0b{% else %}#ef4444{% endif %}{% else %}#475569{% endif %}">
        {% if opp.fit_score %}{{ opp.fit_score }}/10{% else %}‚Äî/10{% endif %}
      </div>
      <div style="font-size:11px;color:#64748b">FIT SCORE</div>
    </div>
    <span class="badge {% if opp.stage in ['Offer Pending'] %}badge-green{% elif opp.stage == 'Closed' %}badge-gray{% elif opp.stage in ['HM Interview','Loop'] %}badge-purple{% elif opp.stage == 'Recruiter Screen' %}badge-blue{% else %}badge-yellow{% endif %}" style="font-size:13px;padding:6px 12px">
      {{ opp.stage }}
    </span>
  </div>
</div>

<div class="grid-2">
  <!-- Left column -->
  <div>
    <!-- Meta info -->
    <div class="card">
      <h2>Details</h2>
      <table style="font-size:13px">
        <tr><td style="color:#64748b;width:130px;padding:6px 0">Source</td><td>{{ opp.source or '‚Äî' }}</td></tr>
        <tr><td style="color:#64748b;padding:6px 0">Tier</td><td>{% if opp.tier %}T{{ opp.tier }}{% else %}‚Äî{% endif %}</td></tr>
        <tr><td style="color:#64748b;padding:6px 0">Job Family</td><td>{{ job_families.get(opp.job_family, '‚Äî') if opp.job_family else '‚Äî' }}</td></tr>
        <tr><td style="color:#64748b;padding:6px 0">Salary Range</td><td>{{ opp.salary_range or '‚Äî' }}</td></tr>
        <tr><td style="color:#64748b;padding:6px 0">Added</td><td>{{ opp.date_added or '‚Äî' }}</td></tr>
        <tr><td style="color:#64748b;padding:6px 0">Applied</td><td>{{ opp.date_applied or '‚Äî' }}</td></tr>
        {% if opp.jd_url %}
        <tr><td style="color:#64748b;padding:6px 0">JD URL</td><td><a href="{{ opp.jd_url }}" target="_blank">View ‚Üó</a></td></tr>
        {% endif %}
      </table>
    </div>

    <!-- Next action -->
    <div class="card">
      <h2>Next Action</h2>
      <div style="color:#f8fafc;margin-bottom:4px">{{ opp.next_action or 'Not set' }}</div>
      <div style="font-size:12px;color:#64748b">Due: {{ opp.next_action_date or '‚Äî' }}</div>
    </div>

    <!-- Change stage -->
    <div class="card">
      <h2>Change Stage</h2>
      <form method="POST" action="/opportunity/{{ opp.id }}/advance">
        <div class="form-group">
          <label>New Stage</label>
          <select name="new_stage" id="stage-select" onchange="toggleCloseReason(this.value)">
            {% for s in stage_order %}
            <option value="{{ s }}" {% if s == opp.stage %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group" id="close-reason-group" style="display:{% if opp.stage == 'Closed' %}block{% else %}none{% endif %}">
          <label>Close Reason</label>
          <select name="close_reason">
            <option value="">‚Äî select ‚Äî</option>
            {% for r in ['Accepted','Declined','Rejected','Ghosted','Withdrew'] %}
            <option value="{{ r }}" {% if opp.close_reason == r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Note (optional)</label>
          <input type="text" name="note" placeholder="What happened?">
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Update Stage</button>
      </form>
    </div>

    <!-- Add note -->
    <div class="card">
      <h2>Add Note</h2>
      <form method="POST" action="/opportunity/{{ opp.id }}/note">
        <div class="form-group">
          <textarea name="note" rows="3" placeholder="Add a note..."></textarea>
        </div>
        <button type="submit" class="btn btn-ghost btn-sm">Save Note</button>
      </form>
      {% if opp.notes %}
      <div style="margin-top:12px;font-size:13px;color:#94a3b8;white-space:pre-wrap;border-top:1px solid #334155;padding-top:12px">{{ opp.notes }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Right column -->
  <div>
    <!-- AI Fit Summary -->
    <div class="card" id="fit-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin-bottom:0">AI Fit Analysis</h2>
        <button class="btn btn-primary btn-sm" id="score-fit-btn" onclick="scoreFit(this)">
          {% if fit_summary %}Re-score{% else %}Score Fit{% endif %}
        </button>
      </div>
      <div id="fit-error" style="display:none;color:#ef4444;font-size:13px;margin-bottom:8px"></div>
      <div id="fit-results">
        {% if fit_summary %}
        {% if fit_summary.score_rationale %}
        <p style="font-size:13px;color:#cbd5e1;margin-bottom:12px">{{ fit_summary.score_rationale }}</p>
        {% endif %}
        {% if fit_summary.top_strengths %}
        <div style="margin-bottom:10px">
          <div style="font-size:11px;color:#10b981;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Strengths</div>
          {% for s in fit_summary.top_strengths %}
          <div style="font-size:13px;color:#94a3b8;padding:2px 0">‚úì {{ s }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% if fit_summary.gaps_or_risks %}
        <div style="margin-bottom:10px">
          <div style="font-size:11px;color:#ef4444;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Gaps / Risks</div>
          {% for g in fit_summary.gaps_or_risks %}
          <div style="font-size:13px;color:#94a3b8;padding:2px 0">‚ö† {{ g }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% if fit_summary.suggested_bullet_rewrite %}
        <div style="background:#0f172a;border-radius:6px;padding:10px;font-size:12px;color:#a3e635;margin-top:8px">
          üí° {{ fit_summary.suggested_bullet_rewrite }}
        </div>
        {% endif %}
        {% else %}
        <div style="color:#475569;font-size:13px">No fit analysis yet. Click "Score Fit" to run AI analysis against your resume.</div>
        {% endif %}
      </div>
    </div>

    <!-- Keywords -->
    {% if keywords %}
    <div class="card">
      <h2>ATS Keywords</h2>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        {% for kw in keywords %}
        <span class="badge badge-gray">{{ kw }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Interview Prep -->
    <div class="card" id="prep-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin-bottom:0">Interview Prep</h2>
        <button class="btn btn-ghost btn-sm" id="prep-btn" onclick="genPrep(this)">Generate Prep</button>
      </div>
      <div id="prep-error" style="display:none;color:#ef4444;font-size:13px;margin-bottom:8px"></div>
      <div id="prep-placeholder" style="color:#475569;font-size:13px">Generate behavioral questions, technical questions, and a company briefing for this role.</div>
      <div id="prep-results" style="display:none"></div>
    </div>

    <!-- Tailored Resume -->
    <div class="card" id="resume-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin-bottom:0">Tailored Resume</h2>
        <button class="btn btn-ghost btn-sm" id="resume-btn" onclick="genResume(this)">
          {% if opp.tailored_resume %}Regenerate{% else %}Generate Tailored Resume{% endif %}
        </button>
      </div>
      <div id="resume-error" style="display:none;color:#ef4444;font-size:13px;margin-bottom:8px"></div>
      <div id="resume-output" style="{% if not opp.tailored_resume %}display:none;{% endif %}">
        <div style="background:#0f172a;border:1px solid #334155;border-radius:6px;padding:14px;font-size:12px;color:#e2e8f0;white-space:pre-wrap;max-height:400px;overflow-y:auto;font-family:monospace;line-height:1.6" id="resume-text">{{ opp.tailored_resume or '' }}</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button class="btn btn-ghost btn-sm" onclick="copyResume()">Copy to Clipboard</button>
          <span id="resume-copy-confirm" style="display:none;font-size:12px;color:#10b981">Copied!</span>
        </div>
        <div id="resume-changes" style="margin-top:12px;display:none">
          <div style="font-size:11px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Key Changes</div>
          <ul id="resume-changes-list" style="font-size:13px;color:#94a3b8;padding-left:18px;margin:0"></ul>
        </div>
      </div>
      {% if not opp.tailored_resume %}
      <div id="resume-placeholder" style="color:#475569;font-size:13px">Generate a full resume rewritten for this specific role and JD.</div>
      {% endif %}
    </div>

    <!-- Contacts -->
    <div class="card">
      <h2>Contacts ({{ contacts|length }})</h2>
      {% if contacts %}
      {% for c in contacts %}
      <div style="border-bottom:1px solid #334155;padding:10px 0;{% if loop.last %}border-bottom:none{% endif %}">
        <div style="font-weight:600;font-size:14px">{{ c.full_name }}</div>
        <div style="font-size:12px;color:#64748b">{{ c.title or '' }}{% if c.company %} ¬∑ {{ c.company }}{% endif %}</div>
        <div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge {% if c.response_status == 'Responded' %}badge-green{% elif c.response_status == 'Meeting Scheduled' %}badge-blue{% elif c.response_status == 'No Response' %}badge-red{% else %}badge-yellow{% endif %}">
            {{ c.response_status }}
          </span>
          <span class="badge badge-gray">{{ c.contact_type or 'Contact' }}</span>
          {% if c.outreach_day0 %}<span style="font-size:11px;color:#64748b">Day 0: {{ c.outreach_day0 }}</span>{% endif %}
        </div>
        <!-- Draft Outreach toggle -->
        <div style="margin-top:8px">
          <button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="toggleOutreach({{ c.id }})">Draft Outreach</button>
          <div id="outreach-{{ c.id }}" style="display:none;margin-top:10px">
            <div class="form-group">
              <label>Hook ‚Äî why you're reaching out</label>
              <textarea id="hook-{{ c.id }}" rows="2" placeholder="e.g. We were both at FinTech Summit, or I saw you lead the data platform rebuild at Acme..."></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <button class="btn btn-primary btn-sm" onclick="draftOutreach({{ c.id }}, this)">Generate</button>
              <button class="btn btn-ghost btn-sm" onclick="toggleOutreach({{ c.id }})">Cancel</button>
            </div>
            <div id="outreach-error-{{ c.id }}" style="display:none;color:#ef4444;font-size:12px;margin-bottom:8px"></div>
            <div id="outreach-result-{{ c.id }}" style="display:none"></div>
          </div>
        </div>
        <!-- Draft Thank You toggle -->
        <div style="margin-top:6px">
          <button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="toggleThankYou({{ c.id }})">Draft Thank You</button>
          <div id="thankyou-{{ c.id }}" style="display:none;margin-top:10px">
            <div class="form-group">
              <label>Key moment from the conversation</label>
              <textarea id="km-{{ c.id }}" rows="2" placeholder="e.g. We discussed migrating from Tableau to Looker..."></textarea>
            </div>
            <div class="form-group">
              <label>Fit point to reinforce</label>
              <textarea id="fp-{{ c.id }}" rows="2" placeholder="e.g. My BigQuery + Looker migration experience is directly applicable..."></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <button class="btn btn-primary btn-sm" onclick="draftThankYou({{ c.id }}, this)">Generate</button>
              <button class="btn btn-ghost btn-sm" onclick="toggleThankYou({{ c.id }})">Cancel</button>
            </div>
            <div id="thankyou-error-{{ c.id }}" style="display:none;color:#ef4444;font-size:12px;margin-bottom:8px"></div>
            <div id="thankyou-result-{{ c.id }}" style="display:none"></div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div style="color:#475569;font-size:13px;padding:8px 0">No contacts added yet.</div>
      {% endif %}

      <!-- Add Contact toggle -->
      <div style="margin-top:12px;border-top:1px solid #334155;padding-top:12px">
        <button class="btn btn-ghost btn-sm" onclick="toggleAddContact()">Ôºã Add Contact</button>
        <form id="add-contact-form" method="POST" action="/opportunity/{{ opp.id }}/add-contact" style="display:none;margin-top:14px">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" name="full_name" required placeholder="Jane Smith">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" placeholder="Hiring Manager">
          </div>
          <div class="form-group">
            <label>Company</label>
            <input type="text" name="company" value="{{ opp.company }}">
          </div>
          <div class="form-group">
            <label>Type</label>
            <select name="contact_type">
              <option value="Hiring Manager">Hiring Manager</option>
              <option value="Recruiter" selected>Recruiter</option>
              <option value="Peer">Peer</option>
              <option value="Alumni">Alumni</option>
              <option value="Referral Source">Referral Source</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" placeholder="jane@company.com">
          </div>
          <div class="form-group">
            <label>LinkedIn URL</label>
            <input type="url" name="linkedin_url" placeholder="https://linkedin.com/in/...">
          </div>
          <div style="display:flex;gap:8px">
            <button type="submit" class="btn btn-primary btn-sm">Add Contact</button>
            <button type="button" class="btn btn-ghost btn-sm" onclick="toggleAddContact()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
      <h2>Activity Log</h2>
      {% if activity %}
      {% for entry in activity %}
      <div style="border-bottom:1px solid #1e293b;padding:8px 0;{% if loop.last %}border-bottom:none{% endif %}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <span class="badge badge-gray" style="font-size:10px">{{ entry.activity_type }}</span>
          <span style="font-size:11px;color:#475569">{{ entry.created_at[:16] if entry.created_at else '' }}</span>
        </div>
        {% if entry.description %}
        <div style="font-size:13px;color:#94a3b8;margin-top:4px">{{ entry.description }}</div>
        {% endif %}
      </div>
      {% endfor %}
      {% else %}
      <div class="empty-state" style="padding:12px">No activity logged yet.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
const OPP_ID = {{ opp.id }};

function toggleCloseReason(stage) {
  document.getElementById('close-reason-group').style.display = stage === 'Closed' ? 'block' : 'none';
}

function genResume(btn) {
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'Generating...';
  document.getElementById('resume-error').style.display = 'none';

  fetch('/opportunity/' + OPP_ID + '/generate-resume', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      if (data.error) {
        btn.textContent = orig;
        const el = document.getElementById('resume-error');
        el.textContent = data.error;
        el.style.display = 'block';
        return;
      }
      btn.textContent = 'Regenerate';
      const placeholder = document.getElementById('resume-placeholder');
      if (placeholder) placeholder.style.display = 'none';
      document.getElementById('resume-text').textContent = data.tailored_resume || '';
      document.getElementById('resume-output').style.display = 'block';
      if (data.key_changes && data.key_changes.length) {
        const list = document.getElementById('resume-changes-list');
        list.innerHTML = '';
        data.key_changes.forEach(c => {
          const li = document.createElement('li');
          li.textContent = c;
          list.appendChild(li);
        });
        document.getElementById('resume-changes').style.display = 'block';
      }
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = orig;
      const el = document.getElementById('resume-error');
      el.textContent = 'Request failed. Check the server logs.';
      el.style.display = 'block';
    });
}

function copyResume() {
  const text = document.getElementById('resume-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const confirm = document.getElementById('resume-copy-confirm');
    confirm.style.display = 'inline';
    setTimeout(() => { confirm.style.display = 'none'; }, 2000);
  });
}

function scoreFit(btn) {
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'Scoring...';
  document.getElementById('fit-error').style.display = 'none';

  fetch('/opportunity/' + OPP_ID + '/score-fit', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      if (data.error) {
        btn.textContent = orig;
        const el = document.getElementById('fit-error');
        el.textContent = data.error;
        el.style.display = 'block';
        return;
      }
      btn.textContent = 'Re-score';
      const score = data.fit_score;
      const scoreColor = score >= 8 ? '#10b981' : score >= 6 ? '#f59e0b' : '#ef4444';
      // Update score badge in header
      const scoreEl = document.getElementById('fit-score-display');
      if (scoreEl) {
        scoreEl.textContent = score + '/10';
        scoreEl.style.color = scoreColor;
      }
      // Rebuild results section
      let html = '';
      if (data.score_rationale) {
        html += '<p style="font-size:13px;color:#cbd5e1;margin-bottom:12px">' + data.score_rationale + '</p>';
      }
      if (data.top_strengths && data.top_strengths.length) {
        html += '<div style="margin-bottom:10px"><div style="font-size:11px;color:#10b981;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Strengths</div>';
        data.top_strengths.forEach(s => { html += '<div style="font-size:13px;color:#94a3b8;padding:2px 0">‚úì ' + s + '</div>'; });
        html += '</div>';
      }
      if (data.gaps_or_risks && data.gaps_or_risks.length) {
        html += '<div style="margin-bottom:10px"><div style="font-size:11px;color:#ef4444;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Gaps / Risks</div>';
        data.gaps_or_risks.forEach(g => { html += '<div style="font-size:13px;color:#94a3b8;padding:2px 0">‚ö† ' + g + '</div>'; });
        html += '</div>';
      }
      if (data.ats_keywords && data.ats_keywords.length) {
        html += '<div style="margin-bottom:10px"><div style="font-size:11px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">ATS Keywords</div><div style="display:flex;flex-wrap:wrap;gap:6px">';
        data.ats_keywords.forEach(k => { html += '<span class="badge badge-gray">' + k + '</span>'; });
        html += '</div></div>';
      }
      if (data.suggested_bullet_rewrite) {
        html += '<div style="background:#0f172a;border-radius:6px;padding:10px;font-size:12px;color:#a3e635;margin-top:8px">üí° ' + data.suggested_bullet_rewrite + '</div>';
      }
      document.getElementById('fit-results').innerHTML = html;
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = orig;
      const el = document.getElementById('fit-error');
      el.textContent = 'Request failed. Check the server logs.';
      el.style.display = 'block';
    });
}

function genPrep(btn) {
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'Generating...';
  document.getElementById('prep-error').style.display = 'none';

  fetch('/opportunity/' + OPP_ID + '/interview-prep', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      if (data.error) {
        btn.textContent = orig;
        const el = document.getElementById('prep-error');
        el.textContent = data.error;
        el.style.display = 'block';
        return;
      }
      btn.textContent = 'Re-generate';
      document.getElementById('prep-placeholder').style.display = 'none';
      let html = '';
      if (data.company_briefing) {
        html += '<div style="margin-bottom:14px"><div style="font-size:11px;color:#3b82f6;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Company Briefing</div><p style="font-size:13px;color:#cbd5e1">' + data.company_briefing + '</p></div>';
      }
      if (data.watch_out_for) {
        html += '<div style="margin-bottom:14px"><div style="font-size:11px;color:#f59e0b;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Watch Out For</div><p style="font-size:13px;color:#94a3b8">‚ö† ' + data.watch_out_for + '</p></div>';
      }
      if (data.behavioral_questions && data.behavioral_questions.length) {
        html += '<div style="margin-bottom:14px"><div style="font-size:11px;color:#10b981;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Behavioral Questions</div>';
        data.behavioral_questions.forEach((q, i) => { html += '<div style="font-size:13px;color:#94a3b8;padding:3px 0">' + (i+1) + '. ' + q + '</div>'; });
        html += '</div>';
      }
      if (data.technical_questions && data.technical_questions.length) {
        html += '<div style="margin-bottom:14px"><div style="font-size:11px;color:#c4b5fd;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Technical Questions</div>';
        data.technical_questions.forEach((q, i) => { html += '<div style="font-size:13px;color:#94a3b8;padding:3px 0">' + (i+1) + '. ' + q + '</div>'; });
        html += '</div>';
      }
      if (data.questions_to_ask_them && data.questions_to_ask_them.length) {
        html += '<div><div style="font-size:11px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Questions to Ask Them</div>';
        data.questions_to_ask_them.forEach((q, i) => { html += '<div style="font-size:13px;color:#94a3b8;padding:3px 0">' + (i+1) + '. ' + q + '</div>'; });
        html += '</div>';
      }
      const results = document.getElementById('prep-results');
      results.innerHTML = html;
      results.style.display = 'block';
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = orig;
      const el = document.getElementById('prep-error');
      el.textContent = 'Request failed. Check the server logs.';
      el.style.display = 'block';
    });
}

function toggleAddContact() {
  const form = document.getElementById('add-contact-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleOutreach(cId) {
  const div = document.getElementById('outreach-' + cId);
  div.style.display = div.style.display === 'none' ? 'block' : 'none';
}

function draftOutreach(cId, btn) {
  const hook = document.getElementById('hook-' + cId).value.trim();
  if (!hook) { document.getElementById('hook-' + cId).focus(); return; }
  const orig = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Generating...';
  document.getElementById('outreach-error-' + cId).style.display = 'none';

  fetch('/contact/' + cId + '/draft-outreach', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'hook=' + encodeURIComponent(hook)
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    if (data.error) {
      btn.textContent = orig;
      const el = document.getElementById('outreach-error-' + cId);
      el.textContent = data.error;
      el.style.display = 'block';
      return;
    }
    btn.textContent = 'Re-generate';
    const box = 'style="background:#0f172a;border-radius:6px;padding:10px;font-size:13px;color:#e2e8f0;white-space:pre-wrap;margin-bottom:4px"';
    const label = 'style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;margin-top:10px"';
    let html = '<div style="border-top:1px solid #334155;padding-top:12px">';
    html += '<div ' + label + ' style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#3b82f6">LinkedIn Note <span style="font-weight:400;color:#475569">(' + (data.linkedin_note||'').length + ' chars)</span></div>';
    html += '<div ' + box + '>' + escHtml(data.linkedin_note || '') + '</div>';
    html += '<button onclick="copyText(\'ln-' + cId + '\')" data-text="' + escAttr(data.linkedin_note||'') + '" id="ln-' + cId + '" class="btn btn-ghost btn-sm" style="font-size:11px;padding:2px 8px">Copy</button>';
    html += '<div ' + label + ' style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#f59e0b;margin-top:10px">Subject Line</div>';
    html += '<div ' + box + '>' + escHtml(data.subject_line || '') + '</div>';
    html += '<div ' + label + ' style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#10b981;margin-top:10px">InMail / Email</div>';
    html += '<div ' + box + '>' + escHtml(data.inmail_or_email || '') + '</div>';
    lastDraft[cId] = {subject: data.subject_line || '', body: data.inmail_or_email || ''};
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">';
    html += '<button onclick="copyText(\'em-' + cId + '\')" data-text="' + escAttr(data.inmail_or_email||'') + '" id="em-' + cId + '" class="btn btn-ghost btn-sm" style="font-size:11px;padding:2px 8px">Copy</button>';
    if (CONTACT_HAS_EMAIL[cId]) {
      html += '<button id="send-outreach-' + cId + '" onclick="sendEmail(' + cId + ', \'outreach\', this)" class="btn btn-primary btn-sm" style="font-size:11px;padding:2px 8px">Send Email</button>';
    }
    html += '<button id="mark-sent-' + cId + '" onclick="markSent(' + cId + ', this)" class="btn btn-ghost btn-sm" style="font-size:11px;padding:2px 8px;border:1px solid #475569">Mark as Sent</button>';
    html += '</div>';
    html += '</div>';
    const res = document.getElementById('outreach-result-' + cId);
    res.innerHTML = html;
    res.style.display = 'block';
  })
  .catch(() => {
    btn.disabled = false;
    btn.textContent = orig;
    const el = document.getElementById('outreach-error-' + cId);
    el.textContent = 'Request failed. Check the server logs.';
    el.style.display = 'block';
  });
}

function copyText(elId) {
  const el = document.getElementById(elId);
  const text = el.dataset.text || el.textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = el.nextElementSibling || el;
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  });
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escAttr(str) {
  return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
}

// --- Email capability map & draft storage ---
const CONTACT_HAS_EMAIL = {
  {% for c in contacts %}{{ c.id }}: {{ 'true' if c.email else 'false' }},
  {% endfor %}
};
const lastDraft = {};
const lastThankYou = {};

function toggleThankYou(cId) {
  const div = document.getElementById('thankyou-' + cId);
  div.style.display = div.style.display === 'none' ? 'block' : 'none';
}

function draftThankYou(cId, btn) {
  const km = document.getElementById('km-' + cId).value.trim();
  const fp = document.getElementById('fp-' + cId).value.trim();
  if (!km) { document.getElementById('km-' + cId).focus(); return; }
  if (!fp) { document.getElementById('fp-' + cId).focus(); return; }
  const orig = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Generating...';
  document.getElementById('thankyou-error-' + cId).style.display = 'none';

  const params = new URLSearchParams({key_moment: km, fit_point: fp});
  fetch('/contact/' + cId + '/draft-thank-you', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: params.toString()
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    if (data.error) {
      btn.textContent = orig;
      const el = document.getElementById('thankyou-error-' + cId);
      el.textContent = data.error;
      el.style.display = 'block';
      return;
    }
    btn.textContent = 'Re-generate';
    lastThankYou[cId] = {subject: data.subject || '', body: data.body || ''};
    const box = 'style="background:#0f172a;border-radius:6px;padding:10px;font-size:13px;color:#e2e8f0;white-space:pre-wrap;margin-bottom:4px"';
    const lbl = 'style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px"';
    let html = '<div style="border-top:1px solid #334155;padding-top:12px">';
    html += '<div ' + lbl + ' style="color:#f59e0b">Subject</div>';
    html += '<div ' + box + '>' + escHtml(data.subject || '') + '</div>';
    html += '<div ' + lbl + ' style="color:#10b981;margin-top:10px">Body</div>';
    html += '<div ' + box + '>' + escHtml(data.body || '') + '</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">';
    html += '<button onclick="copyText(\'ty-' + cId + '\')" data-text="' + escAttr(data.body||'') + '" id="ty-' + cId + '" class="btn btn-ghost btn-sm" style="font-size:11px;padding:2px 8px">Copy Body</button>';
    if (CONTACT_HAS_EMAIL[cId]) {
      html += '<button id="send-ty-' + cId + '" onclick="sendEmail(' + cId + ', \'thank_you\', this)" class="btn btn-primary btn-sm" style="font-size:11px;padding:2px 8px">Send Email</button>';
    }
    html += '</div></div>';
    const res = document.getElementById('thankyou-result-' + cId);
    res.innerHTML = html;
    res.style.display = 'block';
  })
  .catch(() => {
    btn.disabled = false;
    btn.textContent = orig;
    const el = document.getElementById('thankyou-error-' + cId);
    el.textContent = 'Request failed. Check the server logs.';
    el.style.display = 'block';
  });
}

function sendEmail(cId, type, btn) {
  const draft = type === 'outreach' ? lastDraft[cId] : lastThankYou[cId];
  if (!draft || !draft.body) { alert('Generate a draft first.'); return; }
  if (!confirm('Send this email to the contact?')) return;
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'Sending...';
  const params = new URLSearchParams({subject: draft.subject, body: draft.body, email_type: type});
  fetch('/contact/' + cId + '/send-email', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: params.toString()
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      btn.disabled = false;
      btn.textContent = orig;
      alert('Send failed: ' + data.error);
      return;
    }
    btn.textContent = 'Sent ‚úì';
    btn.style.background = '#10b981';
    btn.style.color = '#fff';
    btn.style.border = 'none';
  })
  .catch(() => {
    btn.disabled = false;
    btn.textContent = orig;
    alert('Request failed. Check the server logs.');
  });
}

function markSent(cId, btn) {
  if (!confirm('Mark outreach as sent? This logs today as Day 0 for this contact.')) return;
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'Logging...';
  fetch('/contact/' + cId + '/mark-outreach-sent', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        btn.disabled = false;
        btn.textContent = orig;
        alert('Error: ' + data.error);
        return;
      }
      btn.textContent = 'Day 0 Logged ‚úì';
      btn.style.background = '#10b981';
      btn.style.color = '#fff';
      btn.style.border = 'none';
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = orig;
      alert('Request failed. Check the server logs.');
    });
}
</script>
{% endblock %}
